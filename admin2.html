<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase-config.js"></script>
</head>

<body>
  <div class="admin-container">
    <h2>Welcome, Admin [passed with cgpa or without cgpa] </h2>
    <button id="logout">Logout</button>

    <h3>Upload Results</h3>
    <textarea id="resultInput" placeholder="Paste results here..."></textarea>
    <button id="uploadResults">Upload</button>
    <p id="status"></p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { ref, update } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    // ‚úÖ Redirect if not logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "admin-login.html";
      }
    });

    // ‚úÖ Logout functionality
    document.getElementById("logout").addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "admin-login.html";
      }).catch(error => {
        console.error("‚ùå Logout Error:", error);
      });
    });

    // ‚úÖ Upload results
    document.getElementById("uploadResults").addEventListener("click", async () => {
      let inputText = document.getElementById("resultInput").value.trim();
      let statusMsg = document.getElementById("status");
      statusMsg.innerText = ""; // Clear previous messages

      if (!inputText) {
        alert("‚ùå Please paste results!");
        return;
      }

      let results = {};
      let lines = inputText.split("\n");

      // ‚úÖ Updated Regex to handle long lists of referred subjects and CGPA
      let validPattern = /^(\d{6})\s*cgpa:\s*([\d.]+|NOT PUBLISHED YET)\s*\(([^)]+)\)\s*\[Referred:\s*([^\]]*)\]?\s*$/;
      // Matches: "123456 cgpa: 3.5 (1st: 3.5, 2nd: 3.8) [Referred: 101, 202, 303]"

      lines.forEach(line => {
        let match = line.match(validPattern);
        if (match) {
          let roll = match[1].trim(); // Extract roll number
          let gpaData = {};
          let semesterCount = 0; // Count semesters

          let cgpa = match[2].trim(); // Extract CGPA (could be a number or "NOT PUBLISHED YET")
          let gpaEntries = match[3].split(","); // "1st: 3.5, 2nd: 3.8"
          gpaEntries.forEach(entry => {
            if (semesterCount < 8) { // ‚úÖ Max 8 semesters allowed
              let [key, value] = entry.split(":").map(str => str.trim());
              if (key && value) {
                if (value.toLowerCase() === "ref") {
                  gpaData[key] = "Referred"; // Mark as referred
                } else if (!isNaN(value)) {
                  gpaData[key] = parseFloat(value); // Store GPA if it's a valid number
                }
                semesterCount++;
              }
            }
          });

          let referredSubjects = match[4] ? match[4].trim() : ""; // Extract referred subjects
          referredSubjects = referredSubjects.split(",").map(subject => subject.trim()); // Convert to array

          // ‚úÖ Only add valid GPA data
          if (Object.keys(gpaData).length > 0 || referredSubjects.length > 0 || cgpa === "NOT PUBLISHED YET") {
            results[roll] = {
              cgpa: cgpa, // Store CGPA value as it is (could be number or "NOT PUBLISHED YET")
              gpa: gpaData,
              referred: referredSubjects // Store referred subjects as an array
            };
          }
        }
      });

      if (Object.keys(results).length === 0) {
        statusMsg.innerText = "‚ùå No valid results found!";
        return;
      }

      console.log("‚úÖ Parsed Results:", results); // Debugging

      try {
        for (let roll in results) {
          let dbRef = ref(db, "results/" + roll);
          console.log(`üì° Uploading: ${roll} ‚Üí`, results[roll]); // Log each upload
          await update(dbRef, results[roll]);
        }
        statusMsg.innerText = "‚úÖ Results uploaded successfully!";
        document.getElementById("resultInput").value = ""; // Clear input field
      } catch (error) {
        console.error("‚ùå Firebase Upload Error:", error);
        statusMsg.innerText = "‚ùå Error uploading results!";
      }
    });
  </script>
</body>

</html>
